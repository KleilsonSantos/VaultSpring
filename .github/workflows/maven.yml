name: Java CI with Maven

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout source
        uses: actions/checkout@v4

      - name: ☕ Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: 🛠️ Instalar Maven (para uso com act local)
        if: env.ACT
        run: |
          sudo apt-get update
          sudo apt-get install -y maven

      - name: 🧩 Criar pasta do cache Maven (necessário p/ act)
        if: env.ACT
        run: mkdir -p /root/.m2/repository

      - name: 💾 Cache manual do Maven (fallback)
        uses: actions/cache@v3
        with:
          path: /root/.m2/repository
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-

      - name: 🧹 Análise de código com Checkstyle
        run: mvn checkstyle:check

      - name: 🧪 Build + Test + Coverage (JaCoCo)
        run: mvn clean verify jacoco:report --no-transfer-progress

      - name: 📤 Upload JaCoCo coverage (opcional)
        if: success() && !env.ACT && hashFiles('target/site/jacoco/jacoco.xml') != ''
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco/

      - name: 📊 Submeter grafo de dependência
        uses: advanced-security/maven-dependency-submission-action@v4

      - name: 📦 Upload do JAR gerado
        if: success() && !env.ACT && hashFiles('target/*.jar') != ''
        uses: actions/upload-artifact@v4
        with:
          name: app-build
          path: target/*.jar

      - name: 📈 Enviar relatório para Codecov
        if: success() && !env.ACT && hashFiles('target/site/jacoco/jacoco.xml') != ''
        uses: codecov/codecov-action@v4
        with:
          #token: ${{ secrets.CODECOV_TOKEN }} # remova se o repositório for público
          files: target/site/jacoco/jacoco.xml
          flags: unittests
          name: codecov-coverage
          fail_ci_if_error: false

